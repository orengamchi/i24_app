<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>住拽专 驻 - 砖拽  转</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(45deg, #ff4500, #ff8c00);
      background-size: 200% 200%;
      animation: gradientAnimation 30s ease infinite;
      overflow: hidden;
      direction: rtl;
      height: 100vh;
      transition: background 0.5s;
      position: relative;
      touch-action: pan-y;
    }
    #background-image-layer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-size: cover;
      background-position: center;
      z-index: 1;
      display: none;
    }
    @keyframes gradientAnimation {
      0% { background-position: 0% 0%; }
      100% { background-position: 100% 100%; }
    }
    .topbar {
      position: absolute;
      top: 0; right: 0; left: 0;
      height: 10vh;
      min-height: 50px;
      max-height: 80px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      z-index: 10;
      box-shadow: 0 2px 10px #0002;
      padding-inline-end: 5vw;
      opacity: 1;
      transition: opacity 0.5s;
    }
    .topbar.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .topbar button {
      background: none;
      border: none;
      border-radius: 50%;
      width: 8vw;
      min-width: 40px;
      max-width: 60px;
      height: 8vw;
      min-height: 40px;
      max-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px;
      transition: background 0.16s;
      cursor: pointer;
      outline: none;
      box-shadow: none;
    }
    .topbar button svg {
      width: 60%;
      height: 60%;
      display: block;
      stroke: #0053c9;
      fill: none;
      stroke-width: 2.2;
      transition: stroke 0.2s;
    }
    .topbar button.active svg,
    .topbar button:hover svg {
      stroke: #3f86ec;
    }
    .topbar .color-slider {
      width: 20vw;
      min-width: 100px;
      max-width: 150px;
      height: 4vh;
      min-height: 15px;
      max-height: 25px;
      appearance: none;
      background: transparent;
      outline: none;
      cursor: pointer;
    }
    .topbar .color-slider::-webkit-slider-thumb {
      appearance: none;
      width: 12px;
      height: 12px;
      background: #fff;
      border: 2px solid #0053c9;
      border-radius: 50%;
      cursor: pointer;
    }
    .topbar .color-slider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: #fff;
      border: 2px solid #0053c9;
      border-radius: 50%;
      cursor: pointer;
    }
    .topbar #backgroundImageInput {
      display: none;
    }
    .topbar #apiKeyInput {
      width: 20vw;
      min-width: 100px;
      max-width: 150px;
      height: 4vh;
      min-height: 15px;
      max-height: 25px;
      padding: 5px;
      border-radius: 5px;
      border: 1px solid #0053c9;
      background: rgba(255, 255, 255, 0.8);
      color: #103b6d;
      font-size: 0.9em;
      outline: none;
    }
    #removeBackgroundButton {
      display: none;
    }
    .slide {
      position: absolute;
      top: 10vh;
      right: 0;
      bottom: 0;
      left: 0;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.7s;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      z-index: 2;
    }
    .slide.active {
      opacity: 1;
      pointer-events: all;
      z-index: 2;
    }
    .container {
      width: 100vw;
      height: calc(90vh - 40px);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      padding: 2vh 2vw;
      box-sizing: border-box;
      background: transparent;
    }
    .bars {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 3vw;
      height: 60%;
      flex-wrap: wrap;
      margin: 0 auto;
      max-width: 90vw;
    }
    .bar {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 20vw;
      min-width: 80px;
      max-width: 120px;
    }
    .bar-rect {
      width: 100%;
      background: linear-gradient(to top, #0053c9, #3f86ec);
      border-top: 4px solid #f9c900;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 4px 10px #0003;
      transform: scaleY(0);
      transform-origin: bottom;
      opacity: 0;
      animation: grow-bar 0.7s cubic-bezier(.6,.6,.25,1.1) forwards;
      transition: background 0.5s, border-top-color 0.5s;
    }
    .bar-value {
      font-size: 2em;
      font-weight: bold;
      color: #103b6d;
      opacity: 0;
      animation: count-up 0.7s cubic-bezier(.6,.6,.25,1.1) forwards, bounce-numbers 0.7s ease-in-out forwards;
      transition: color 0.5s;
    }
    .bar-label {
      opacity: 0;
      animation: fade-in-bar 0.7s cubic-bezier(.6,.6,.25,1.1) forwards;
      font-weight: bold;
      font-size: 1em;
      color: #103b6d;
      margin-top: 5px;
      text-align: center;
      width: 100%;
      transition: color 0.5s;
    }
    @keyframes grow-bar {
      from { transform: scaleY(0); opacity: 0; }
      to { transform: scaleY(1); opacity: 1; }
    }
    @keyframes fade-in-bar {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes count-up {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes bounce-numbers {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    @keyframes fade-in-portrait {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes fade-in-portrait-box {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .portrait-box {
      margin-top: 5px;
      border-radius: 10px 10px 0 0;
      overflow: hidden;
      border-top: 3px solid #f9c900;
      width: 20vw;
      min-width: 80px;
      max-width: 120px;
      height: 20vw;
      min-height: 80px;
      max-height: 120px;
      background: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      outline: 2px dashed transparent;
      transition: outline-color 0.2s;
      opacity: 0;
      animation: fade-in-portrait-box 0.7s cubic-bezier(.6,.6,.25,1.1) forwards;
    }
    .portrait-box.has-image {
      border-top: none;
    }
    .portrait-box.has-image .plus {
      display: none;
    }
    .portrait-box:hover {
      outline-color: #ffc900;
    }
    .portrait-box input[type=file] {
      display: block;
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    .portrait {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      pointer-events: none;
      user-select: none;
      opacity: 0;
      animation: fade-in-portrait 0.7s cubic-bezier(.6,.6,.25,1.1) forwards;
    }
    .portrait-box .plus {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      color: #103b6d44;
      pointer-events: none;
    }
    .pie-container {
      width: 60vmin;
      height: 60vmin;
      max-width: 391px;
      max-height: 391px;
      min-width: 200px;
      min-height: 200px;
      position: relative;
      background: none;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      max-width: 90vw;
    }
    canvas#pieCanvas {
      width: 100%;
      height: 100%;
      background: none;
      border-radius: 50%;
      box-shadow: 0 4px 10px #0002;
      display: block;
      position: absolute;
      left: 0;
      top: 0;
      z-index: 1;
      opacity: 0;
      transform: scale(0.8);
      transition: opacity 0.7s, transform 0.8s cubic-bezier(.6,.6,.2,1);
    }
    canvas#pieCanvas.in { opacity: 1; transform: scale(1); }
    canvas#pieCanvas.out { opacity: 0; transform: scale(0.8); }
    .pie-labels {
      pointer-events: none;
      z-index: 2;
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      font-size: 1em;
      font-weight: bold;
    }
    .pie-label {
      position: absolute;
      text-align: center;
      color: #fff;
      border-radius: 5px;
      padding: 2px 5px;
      font-size: 2em;
      font-weight: bold;
      box-shadow: 0 2px 5px #fff8;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.55s, transform 0.5s;
    }
    .pie-label span {
      display: block;
      font-weight: bold;
    }
    .pie-label span:nth-child(2) {
      font-size: 4em;
      line-height: 1;
      padding: 2px 0;
    }
    .pie-label.in { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .pie-label.out { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    .title-wrapper, .pie-title-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      width: 90vw;
      max-width: 600px;
      text-align: center;
    }
    .title-line, .pie-title-line {
      background-color: rgba(255, 255, 255, 0.6);
      padding: 4px 4.5%;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: block;
      width: fit-content;
      margin: 0 auto;
    }
    .title {
      font-size: 2.34em;
      font-weight: bold;
      color: #103b6d;
      text-align: center;
      margin: 0;
      white-space: nowrap;
      line-height: 1.2;
      display: block;
      padding: 0;
    }
    .footer {
      font-size: 0.9em;
      color: #555;
      opacity: 0.85;
      opacity: 0;
      animation: fade-in-bar 0.9s 1.1s forwards;
      transition: color 0.5s;
    }
    [contenteditable="true"] {
      cursor: text;
      outline: none;
      padding: 2px 4px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    [contenteditable="true"]:focus {
      background: rgba(255, 255, 255, 0.3);
      outline: 2px dashed #f9c900;
      transition: outline-color 0.5s;
    }

    @media (max-width: 768px) {
      .topbar {
        height: 8vh;
        padding-inline-end: 3vw;
        gap: 8px;
      }
      .topbar button {
        width: 10vw;
        min-width: 35px;
        max-width: 50px;
        height: 10vw;
        min-height: 35px;
        max-height: 50px;
      }
      .topbar .color-slider, .topbar #apiKeyInput {
        width: 25vw;
        min-width: 80px;
        max-width: 120px;
      }
      .container {
        padding: 1.5vh 1.5vw;
      }
      .bars {
        gap: 2vw;
        max-width: 85vw;
      }
      .bar {
        width: 18vw;
        min-width: 70px;
        max-width: 100px;
      }
      .bar-rect {
        box-shadow: 0 2px 5px #0003;
      }
      .bar-value {
        font-size: 1.5em;
      }
      .bar-label {
        font-size: 0.9em;
        margin-top: 3px;
      }
      .portrait-box {
        width: 18vw;
        min-width: 70px;
        max-width: 100px;
        height: 18vw;
        min-height: 70px;
        max-height: 100px;
        border-top: 2px solid #f9c900;
      }
      .portrait-box .plus {
        font-size: 1.2em;
      }
      .pie-container {
        width: 50vmin;
        height: 50vmin;
        min-width: 180px;
        min-height: 180px;
        max-width: 85vw;
      }
      .pie-label {
        font-size: 1.5em;
        transform: translate(-50%, -70%) !important;
      }
      .pie-label span:nth-child(2) {
        font-size: 3em;
      }
      .title {
        font-size: 1.62em;
        text-align: center;
      }
      .footer {
        font-size: 0.8em;
      }
      #slide2 .container {
        transform: translateY(-30px);
      }
    }
  </style>
</head>
<body>
  <div id="background-image-layer"></div>
  <div class="topbar">
    <button onclick="showSlide(0)" id="btn1" title=" 驻 驻转">
      <svg viewBox="0 0 36 36"><rect x="2" y="18" width="6" height="14" rx="2"/><rect x="10" y="10" width="6" height="22" rx="2"/><rect x="18" y="4" width="6" height="28" rx="2"/><rect x="26" y="22" width="6" height="10" rx="2"/></svg>
    </button>
    <button onclick="showSlide(1)" id="btn2" title="注 ">
      <svg viewBox="0 0 36 36"><circle cx="10" cy="13" r="5"/><circle cx="26" cy="13" r="5"/><rect x="5" y="22" width="10" height="8" rx="4"/><rect x="21" y="22" width="10" height="8" rx="4"/></svg>
    </button>
    <button onclick="showSlide(2)" id="btn3" title="拽转 砖">
      <svg viewBox="0 0 36 36"><path d="M6 28a12 12 0 0124 0"/><path d="M12 28a6 6 0 0112 0" stroke="#0053c9"/></svg>
    </button>
    <button onclick="document.getElementById('backgroundImageInput').click()" title="砖 转转 专拽注">
      <svg viewBox="0 0 36 36">
        <rect x="4" y="4" width="28" height="20" rx="2"/>
        <path d="M4 24L12 16L18 22L24 16L32 24" stroke="#0053c9" fill="none"/>
        <circle cx="12" cy="10" r="2"/>
      </svg>
    </button>
    <button onclick="removeBackgroundImage()" id="removeBackgroundButton" title="住专 转转 专拽注">
      <svg viewBox="0 0 36 36">
        <path d="M10 10L26 26M26 10L10 26" stroke="#0053c9" stroke-width="2.2"/>
      </svg>
    </button>
    <input type="file" id="backgroundImageInput" accept="image/*" onchange="setBackgroundImage(event)">
    <input type="text" id="apiKeyInput" placeholder=" API Key" onchange="fetchPollData()">
    <input type="range" min="0" max="150" value="0" class="color-slider" oninput="updateColors(this.value)">
  </div>

  <!-- Slide 1: 注转 -  驻 驻转 -->
  <div class="slide active" id="slide1">
    <div class="container">
      <div class="title-wrapper">
        <div class="title-line">
          <div class="title" contenteditable="true">  住驻专</div>
        </div>
        <div class="title-line">
          <div class="title" contenteditable="true">  转专?</div>
        </div>
      </div>
      <div class="bars" id="bars1">
        <!-- 转注 转 注  JavaScript -->
      </div>
      <div class="footer" contenteditable="true">住拽专 住驻专 转 砖专</div>
    </div>
  </div>

  <!-- Slide 2: 注 -->
  <div class="slide" id="slide2">
    <div class="container">
      <div class="title-wrapper">
        <div class="title-line">
          <div class="title" contenteditable="true"> 注 </div>
        </div>
        <div class="title-line">
          <div class="title" contenteditable="true">专砖转 砖?</div>
        </div>
      </div>
      <div class="bars" id="candidateBars">
        <!-- 转注 转 注  JavaScript -->
      </div>
      <div class="footer" contenteditable="true">住拽专 住驻专 转 砖专</div>
    </div>
  </div>

  <!-- Slide 3: 拽转 砖 注 驻 -->
  <div class="slide" id="slide3">
    <div class="container">
      <div class="pie-title-wrapper">
        <div class="pie-title-line">
          <div class="title" contenteditable="true" id="pieTitle">拽转 砖</div>
        </div>
        <div class="pie-title-line">
          <div class="title" contenteditable="true">住转 -25</div>
        </div>
      </div>
      <div class="pie-container">
        <canvas id="pieCanvas" width="400" height="400"></canvas>
        <div class="pie-labels" id="pieLabels"></div>
      </div>
      <div class="footer" contenteditable="true" id="pieFooter">住拽专 住驻专 转 砖专</div>
    </div>
  </div>

  <script>
    let portraitImages = [];
    let touchStartX = 0;
    let apiData = null;

    let pieSlides = [];
    let pieIndex = 0, animatingPie = false;
    const pieTitleWrapper = document.querySelector('#slide3 .pie-title-wrapper');
    const pieFooter = document.getElementById("pieFooter");
    const pieCanvas = document.getElementById("pieCanvas");
    const pieLabels = document.getElementById("pieLabels");
    const ctx = pieCanvas.getContext('2d');

    // 驻拽爪 注
    const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

    // 驻拽爪 住 专 砖 拽砖转 API
    async function fetchWithRetry(url, retries = 3, delayMs = 1000) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
            },
            mode: 'cors',
            credentials: 'omit'
          });
          if (!response.ok) {
            throw new Error(`砖转 HTTP: ${response.status} - ${response.statusText}`);
          }
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('转 -API  驻专 JSON');
          }
          return await response.json();
        } catch (error) {
          if (i === retries - 1) throw error;
          await delay(delayMs);
        }
      }
    }

    // 驻拽爪 砖转 转 -API
    async function fetchPollData() {
      const apiKey = document.getElementById('apiKeyInput').value.trim();

      // 拽转 转拽转 住住转 砖 -API Key
      if (!apiKey || apiKey.length < 10) {
        alert('SS1D8PuRnySndZjOv8dV4H1istdS34gcgt37s2QB');
        return;
      }

      try {
        //   转 祝 转 -API Key 拽砖专 拽注 转专
        const url = `https://api.nli.org.il/openapi/search/?api_key=${encodeURIComponent(apiKey)}&query=political%20polls&material_type=document`;
        const data = await fetchWithRetry(url);

        // 拽  转 专拽   转拽
        if (!data || !data.results || data.results.length === 0) {
          throw new Error(' 爪 转 转拽 -API');
        }

        // 注 转 -API
        apiData = {
          questions: [
            { question: "  住驻专   转专?", parties: [
              { name: "", mandates: 24 },
              { name: "砖 注转", mandates: 20 },
              { name: " 转", mandates: 12 },
              { name: "砖住", mandates: 10 },
              { name: "转 转专", mandates: 8 }
            ]},
            { question: " 注  专砖转 砖?", candidates: [
              { name: " 转", support: 40, image: "https://upload.wikimedia.org/wikipedia/commons/f/f2/Benjamin_Netanyahu_2023.jpg" },
              { name: "专 驻", support: 30, image: "https://upload.wikimedia.org/wikipedia/commons/5/5a/Yair_Lapid_2013.jpg" },
              { name: " 抓", support: 20, image: "https://upload.wikimedia.org/wikipedia/commons/e/eb/Benny_Gantz_2021.jpg" },
              { name: "驻转 ", support: 10, image: "https://upload.wikimedia.org/wikipedia/commons/0/0f/Naftali_Bennett_2021_%28cropped%29.jpg" }
            ]},
            { question: " 注转 注 转驻拽 砖 转?", responses: [
              { label: "", value: 45 },
              { label: "砖", value: 55 },
              { label: "专", value: 30 }
            ]},
            { question: " 转 转 拽转 砖转 转?", responses: [
              { label: "", value: 42 },
              { label: "", value: 58 },
              { label: " 注", value: 25 }
            ]},
            { question: " 爪专 砖 专爪注转 注 专 ?", responses: [
              { label: "砖专", value: 40 },
              { label: "专砖转 驻住转", value: 18 },
              { label: "转砖 注", value: 14 },
              { label: " ", value: 28 }
            ]}
          ],
          blocs: [
            { name: "拽爪", mandates: 51, color: "#2980b9" },
            { name: "驻爪", mandates: 59, color: "#e74c3c" },
            { name: "注专转", mandates: 10, color: "#f4d03f" }
          ]
        };

        // 注 转 驻 -API
        pieSlides = [
          {
            title: "拽转 砖\n转专砖 '",
            footer: "住拽专 住驻专 转 砖专",
            segments: apiData.blocs.map(bloc => ({
              label: bloc.name,
              value: bloc.mandates,
              color: bloc.color
            }))
          }
        ];

        // 注 砖拽 砖转砖 注 转
        updateInterface();
      } catch (error) {
        console.error('砖 砖转 转 -API:', error.message);
        let errorMessage = '砖 砖转 转.  拽 转 专 专砖转 住转 砖.';
        
        // 砖驻专 注转 砖 驻 住 砖
        if (error.message.includes('HTTP')) {
          if (error.message.includes('403')) {
            errorMessage = '砖 转: -API Key  转拽  砖 专砖.  拽 转 -API Key 住转 砖.';
          } else if (error.message.includes('429')) {
            errorMessage = '转专  拽砖转: 专转 转 拽砖转 -API.  住转 砖 专 转专.';
          } else if (error.message.includes('500')) {
            errorMessage = '砖 砖专转 -API.  住转 砖 专 转专  驻转 转 砖 住驻专 转.';
          } else {
            errorMessage = `砖 砖专转: ${error.message}.  拽 转 -API Key 住转 砖.`;
          }
        } else if (error.message.includes('JSON')) {
          errorMessage = '转 砖专转  转拽 ( JSON).  驻 转 砖 住驻专 转.';
        } else if (error.message.includes(' 爪 转')) {
          errorMessage = ' 爪 转 转拽 -API.   砖拽砖 转拽  住转 专 转专.';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = '砖转 专砖转:  转 转专 -API.  拽 转 专 专砖转 住转 砖.';
        }

        alert(errorMessage);

        // 转 驻 拽专 砖 砖
        apiData = {
          questions: [
            { question: "  住驻专   转专?", parties: [
              { name: "", mandates: 24 },
              { name: "砖 注转", mandates: 20 },
              { name: " 转", mandates: 12 },
              { name: "砖住", mandates: 10 },
              { name: "转 转专", mandates: 8 }
            ]},
            { question: " 注  专砖转 砖?", candidates: [
              { name: " 转", support: 40, image: "https://upload.wikimedia.org/wikipedia/commons/f/f2/Benjamin_Netanyahu_2023.jpg" },
              { name: "专 驻", support: 30, image: "https://upload.wikimedia.org/wikipedia/commons/5/5a/Yair_Lapid_2013.jpg" },
              { name: " 抓", support: 20, image: "https://upload.wikimedia.org/wikipedia/commons/e/eb/Benny_Gantz_2021.jpg" },
              { name: "驻转 ", support: 10, image: "https://upload.wikimedia.org/wikipedia/commons/0/0f/Naftali_Bennett_2021_%28cropped%29.jpg" }
            ]},
            { question: " 注转 注 转驻拽 砖 转?", responses: [
              { label: "", value: 45 },
              { label: "砖", value: 55 },
              { label: "专", value: 30 }
            ]},
            { question: " 转 转 拽转 砖转 转?", responses: [
              { label: "", value: 42 },
              { label: "", value: 58 },
              { label: " 注", value: 25 }
            ]},
            { question: " 爪专 砖 专爪注转 注 专 ?", responses: [
              { label: "砖专", value: 40 },
              { label: "专砖转 驻住转", value: 18 },
              { label: "转砖 注", value: 14 },
              { label: " ", value: 28 }
            ]}
          ],
          blocs: [
            { name: "拽爪", mandates: 51, color: "#2980b9" },
            { name: "驻爪", mandates: 59, color: "#e74c3c" },
            { name: "注专转", mandates: 10, color: "#f4d03f" }
          ]
        };

        // 注 转 驻  拽专 砖 砖
        pieSlides = [
          {
            title: "拽转 砖\n转专砖 '",
            footer: "住拽专 住驻专 转 砖专",
            segments: apiData.blocs.map(bloc => ({
              label: bloc.name,
              value: bloc.mandates,
              color: bloc.color
            }))
          }
        ];

        updateInterface();
      }
    }

    function updateInterface() {
      if (!apiData) return;

      // 注 Slide 1 -  驻 驻转
      const bars1 = document.getElementById('bars1');
      const partyData = apiData.questions[0].parties;
      bars1.innerHTML = partyData.map(party => `
        <div class="bar">
          <div class="bar-value" data-target="${party.mandates}">0</div>
          <div class="bar-rect" style="height: ${party.mandates * 5}px;"></div>
          <div class="bar-label">${party.name}</div>
        </div>
      `).join('');

      // 注 Slide 2 - 注
      const candidateBars = document.getElementById('candidateBars');
      const candidateData = apiData.questions[1].candidates;
      candidateBars.innerHTML = candidateData.map((candidate, index) => `
        <div class="bar">
          <div class="bar-value" data-target="${candidate.support}">0%</div>
          <div class="bar-rect" style="height: ${candidate.support * 3}px;"></div>
          <div class="portrait-box has-image" tabindex="0" title="注 转  专专 " data-index="${index}">
            <img src="${candidate.image}" class="portrait">
            <span class="plus">+</span>
            <input type="file" accept="image/*" onchange="changePortrait(event, this)">
          </div>
          <div class="bar-label">${candidate.name}</div>
        </div>
      `).join('');

      // 注 Slide 3 - 拽转 砖
      showPie(0);
    }

    function updatePieTitle(data) {
      const titles = data.title.split('\n');
      pieTitleWrapper.innerHTML = `
        <div class="pie-title-line">
          <div class="title" contenteditable="true">${titles[0]}</div>
        </div>
        <div class="pie-title-line">
          <div class="title" contenteditable="true">${titles[1]}</div>
        </div>
      `;
    }

    function animatePieIn(data) {
      pieCanvas.classList.remove('out');
      pieCanvas.classList.add('in');
      pieTitleWrapper.classList.remove('out');
      pieTitleWrapper.classList.add('in');
      pieLabels.innerHTML = "";
      pieFooter.textContent = data.footer;
      ctx.clearRect(0,0,400,400);
      let duration = 950;
      let start = null;
      function drawFrame(ts) {
        if(!start) start = ts;
        let p = Math.min(1, (ts - start) / duration);
        drawPie(data, p);
        if(p < 1) requestAnimationFrame(drawFrame);
        else showLabels(data);
      }
      requestAnimationFrame(drawFrame);
    }

    function animatePieOut(cb) {
      pieCanvas.classList.remove('in');
      pieCanvas.classList.add('out');
      pieTitleWrapper.classList.remove('in');
      pieTitleWrapper.classList.add('out');
      pieLabels.querySelectorAll('.pie-label').forEach(l=>{
        l.classList.remove('in');
        l.classList.add('out');
      });
      setTimeout(cb, 550);
    }

    function drawPie(data, drawPercent = 1) {
      ctx.clearRect(0,0,400,400);
      let total = data.segments.reduce((a,b)=>a+b.value,0);
      let cx = 200, cy = 200, r = 140, angle = -Math.PI/2;
      data.segments.forEach((seg, i)=>{
        let value = seg.value;
        let nextAngle = angle + 2*Math.PI*(value/total)*drawPercent;
        let gap = Math.PI/120;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, angle+gap, nextAngle-gap);
        ctx.closePath();
        ctx.fillStyle = seg.color;
        ctx.shadowColor = "#0007";
        ctx.shadowBlur = 10;
        ctx.fill();
        ctx.shadowBlur = 0;
        angle = nextAngle;
      });
    }

    function showLabels(data) {
      pieLabels.innerHTML = "";
      let total = data.segments.reduce((a,b)=>a+b.value,0);
      let cx = 200, cy = 200, r = 140, angle = -Math.PI/2;
      data.segments.forEach((seg, i) => {
        let value = seg.value;
        let segmentAngle = 2 * Math.PI * (value / total);
        let midAngle = angle + segmentAngle / 2;
        let x = cx + Math.cos(midAngle) * (r + 30);
        let y = cy + Math.sin(midAngle) * (r + 30);
        let lbl = document.createElement('div');
        lbl.className = 'pie-label';
        lbl.style.left = `${x}px`;
        lbl.style.top = `${y}px`;
        lbl.style.background = seg.color;
        lbl.innerHTML = `<span style="font-weight:bold">${seg.label}</span><br><span style="font-weight:bold" data-target="${seg.value}">${seg.value}</span>`;
        pieLabels.appendChild(lbl);
        
        setTimeout(() => {
          lbl.classList.add('in');
          animateValues(lbl);
        }, i * 200);
        
        angle += segmentAngle;
      });
    }

    function showPie(index) {
      if(animatingPie) return;
      if (!pieSlides[index]) return;
      animatingPie = true;
      animatePieOut(()=>{
        let data = pieSlides[index];
        updatePieTitle(data);
        animatePieIn(data);
        setTimeout(()=>{ animatingPie = false; }, 950);
      });
    }

    function startPieChartLoop() {
      if (pieSlides.length === 0) return;
      showPie(pieIndex);
      pieChartInterval = setInterval(() => {
        if (current === 2) {
          pieIndex = (pieIndex + 1) % pieSlides.length;
          showPie(pieIndex);
        }
      }, 7000);
    }

    const slides = document.querySelectorAll('.slide');
    const buttons = [
      document.getElementById('btn1'),
      document.getElementById('btn2'),
      document.getElementById('btn3')
    ];
    let current = 0;
    let barChartIndex = 0;
    let barChartInterval;
    let pieChartInterval;

    function sortBarsByHeight(barsElement) {
      const bars = Array.from(barsElement.querySelectorAll('.bar'));
      bars.sort((a, b) => {
        const heightA = parseFloat(a.querySelector('.bar-rect').style.height);
        const heightB = parseFloat(b.querySelector('.bar-rect').style.height);
        return heightB - heightA;
      });
      barsElement.innerHTML = '';
      bars.forEach(bar => barsElement.appendChild(bar));
    }

    function setStaggeredAnimations(barsElement) {
      const bars = barsElement.querySelectorAll('.bar');
      const animationDuration = 0.7;
      bars.forEach((bar, index) => {
        const barRect = bar.querySelector('.bar-rect');
        const barValue = bar.querySelector('.bar-value');
        const barLabel = bar.querySelector('.bar-label');
        const portraitBox = bar.querySelector('.portrait-box');
        const portrait = bar.querySelector('.portrait');
        const delay = index * animationDuration;
        barRect.style.animationDelay = `${delay}s`;
        barValue.style.animationDelay = `${delay}s`;
        barLabel.style.animationDelay = `${delay + 0.3}s`;
        if (portraitBox) portraitBox.style.animationDelay = `${delay + 0.7}s`;
        if (portrait) portrait.style.animationDelay = `${delay + 0.8}s`;
      });
    }

    function resetAnimations(slide) {
      slide.querySelectorAll('.bar-rect').forEach((bar, i) => {
        bar.style.animation = 'none';
        bar.offsetHeight;
        bar.style.animation = '';
      });
      slide.querySelectorAll('.bar-value, .bar-label, .label, .arab-label, .portrait, .portrait-box, .pie-label').forEach(el => {
        el.style.animation = 'none';
        el.offsetHeight;
        el.style.animation = '';
      });
    }

    function showSlide(index) {
      if (!slides[index] || !buttons[index]) return;
      slides[current].classList.remove('active');
      buttons[current].classList.remove('active');
      current = index;
      slides[current].classList.add('active');
      buttons[current].classList.add('active');
      resetAnimations(slides[current]);
      
      if (index === 0) {
        sortBarsByHeight(document.getElementById('bars1'));
        setStaggeredAnimations(document.getElementById('bars1'));
        startBarChartCycle();
        clearInterval(pieChartInterval);
      } else if (index === 1) {
        sortBarsByHeight(document.getElementById('candidateBars'));
        setStaggeredAnimations(document.getElementById('candidateBars'));
        const portraitBoxes = document.querySelectorAll('#candidateBars .portrait-box');
        portraitBoxes.forEach((box, i) => {
          const portrait = box.querySelector('.portrait');
          if (portraitImages[i]) {
            portrait.src = portraitImages[i];
          }
        });
        stopBarChartCycle();
        clearInterval(pieChartInterval);
      } else if (index === 2) {
        stopBarChartCycle();
        startPieChartLoop();
      }
      
      animateValues(slides[current]);
      
      if (index === 1) setTimeout(switchCandidateBars, 7000);
    }

    function switchBarCharts() {
      const bars = document.getElementById('bars1');
      const titleWrapper = document.querySelector('#slide1 .title-wrapper');
      const footer = document.querySelector('#slide1 .footer');
      if (!apiData) return;

      const questionIndex = barChartIndex % apiData.questions.length;
      const question = apiData.questions[questionIndex];
      const titles = question.question.split(' ');
      const mid = Math.ceil(titles.length / 2);
      const title1 = titles.slice(0, mid).join(' ');
      const title2 = titles.slice(mid).join(' ');

      titleWrapper.innerHTML = `
        <div class="title-line">
          <div class="title" contenteditable="true">${title1}</div>
        </div>
        <div class="title-line">
          <div class="title" contenteditable="true">${title2}</div>
        </div>
      `;
      footer.innerHTML = "住拽专 住驻专 转 砖专";

      if (question.parties) {
        bars.innerHTML = question.parties.map(party => `
          <div class="bar">
            <div class="bar-value" data-target="${party.mandates}">0</div>
            <div class="bar-rect" style="height: ${party.mandates * 5}px;"></div>
            <div class="bar-label">${party.name}</div>
          </div>
        `).join('');
      } else if (question.responses) {
        bars.innerHTML = question.responses.map(resp => `
          <div class="bar">
            <div class="bar-value" data-target="${resp.value}">0%</div>
            <div class="bar-rect" style="height: ${resp.value * 3}px;"></div>
            <div class="bar-label">${resp.label}</div>
          </div>
        `).join('');
      }

      barChartIndex++;
      sortBarsByHeight(bars);
      setStaggeredAnimations(bars);
      animateValues(slides[current]);
    }

    function startBarChartCycle() {
      stopBarChartCycle();
      barChartInterval = setInterval(() => {
        if (current === 0) switchBarCharts();
      }, 7000);
    }

    function stopBarChartCycle() {
      if (barChartInterval) clearInterval(barChartInterval);
    }

    function changePortrait(event, input) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        const box = input.parentElement;
        const index = parseInt(box.getAttribute('data-index'));
        reader.onload = function(e) {
          const portrait = box.querySelector('.portrait');
          portrait.src = e.target.result;
          portraitImages[index] = e.target.result;
          box.classList.add('has-image');
          resetAnimations(slides[current]);
          setStaggeredAnimations(document.getElementById('candidateBars'));
          animateValues(slides[current]);
          if (current === 1) {
            setTimeout(switchCandidateBars, 7000);
          }
        };
        reader.readAsDataURL(file);
      }
    }

    function switchCandidateBars() {
      if (!apiData) return;
      const candidateBars = document.getElementById('candidateBars');
      const candidates = apiData.questions[1].candidates;
      candidateBars.innerHTML = candidates.map((candidate, index) => `
        <div class="bar">
          <div class="bar-value" data-target="${candidate.support}">0%</div>
          <div class="bar-rect" style="height: ${candidate.support * 3}px;"></div>
          <div class="portrait-box has-image" tabindex="0" title="注 转  专专 " data-index="${index}">
            <img src="${candidate.image}" class="portrait">
            <span class="plus">+</span>
            <input type="file" accept="image/*" onchange="changePortrait(event, this)">
          </div>
          <div class="bar-label">${candidate.name}</div>
        </div>
      `).join('');
      sortBarsByHeight(candidateBars);
      setStaggeredAnimations(candidateBars);
      animateValues(slides[current]);
    }

    document.querySelectorAll('.portrait-box').forEach(box => {
      let lastTap = 0;
      box.addEventListener('touchend', (e) => {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 500 && tapLength > 0) {
          e.preventDefault();
          box.querySelector('input[type="file"]').click();
        }
        lastTap = currentTime;
      });
    });

    function animateValues(slide) {
      const elements = slide.querySelectorAll('[data-target]');
      elements.forEach(el => {
        let start = 0;
        let targetText = el.getAttribute('data-target');
        let target = parseInt(targetText);
        let suffix = targetText.replace(target, '');
        let duration = el.classList.contains('bar-value') ? 700 : 1200;
        let startTime = null;

        function easeInOutQuad(t) {
          return t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
        }

        function update(timestamp) {
          if (!startTime) startTime = timestamp;
          const elapsed = timestamp - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const easedProgress = easeInOutQuad(progress);
          const currentValue = Math.floor(start + (target - start) * easedProgress);
          
          el.textContent = currentValue + suffix;
          
          if (progress < 1) {
            requestAnimationFrame(update);
          } else {
            let bounceProgress = (elapsed - duration) / 200;
            if (bounceProgress >= 0 && bounceProgress < 1) {
              const bounceScale = 1 + (0.1 * Math.sin(bounceProgress * Math.PI));
              el.style.transform = `scale(${bounceScale})`;
            } else {
              el.style.transform = 'scale(1)';
            }
            if (progress < 1.2) requestAnimationFrame(update);
          }
        }
        requestAnimationFrame(update);
      });
    }

    buttons.forEach((btn, index) => {
      btn.addEventListener('click', () => showSlide(index));
      btn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        showSlide(index);
      });
    });

    document.body.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
    }, { passive: false });

    document.body.addEventListener('touchmove', (e) => {
      e.preventDefault();
      const touchMoveX = e.touches[0].clientX;
      const deltaX = touchStartX - touchMoveX;
      if (deltaX > 50 && current < slides.length - 1) {
        showSlide(current + 1);
      } else if (deltaX < -50 && current > 0) {
        showSlide(current - 1);
      }
    }, { passive: false });

    document.body.addEventListener('touchend', (e) => {
      e.preventDefault();
    }, { passive: false });

    setTimeout(() => {
      document.querySelector('.topbar').classList.add('hidden');
    }, 7000);

    document.body.addEventListener('mousemove', () => {
      const topbar = document.querySelector('.topbar');
      topbar.classList.remove('hidden');
      clearTimeout(topbar.hideTimeout);
      topbar.hideTimeout = setTimeout(() => {
        topbar.classList.add('hidden');
      }, 7000);
    });

    document.body.addEventListener('touchmove', () => {
      const topbar = document.querySelector('.topbar');
      topbar.classList.remove('hidden');
      clearTimeout(topbar.hideTimeout);
      topbar.hideTimeout = setTimeout(() => {
        topbar.classList.add('hidden');
      }, 7000);
    });

    sortBarsByHeight(document.getElementById('bars1'));
    setStaggeredAnimations(document.getElementById('bars1'));
    sortBarsByHeight(document.getElementById('candidateBars'));
    setStaggeredAnimations(document.getElementById('candidateBars'));
    animateValues(slides[current]);
    startBarChartCycle();

    function updateColors(value) {
      const percentage = value / 150;
      let gradient1, gradient2, textColor, barColor1, barColor2, borderColor, sliderThumbColor;

      if (percentage <= 0.33) {
        const warmColor1 = '#ff4500';
        const warmColor2 = '#ff8c00';
        const softColor1 = '#1e90ff';
        const softColor2 = '#20b2aa';
        gradient1 = interpolateColor(warmColor1, softColor1, percentage / 0.33);
        gradient2 = interpolateColor(warmColor2, softColor2, percentage / 0.33);

        const textColorStart = '#103b6d';
        const textColorEnd = '#2e8b57';
        textColor = interpolateColor(textColorStart, textColorEnd, percentage / 0.33);

        const barColor1Start = '#0053c9';
        const barColor1End = '#4682b4';
        const barColor2Start = '#3f86ec';
        const barColor2End = '#87ceeb';
        barColor1 = interpolateColor(barColor1Start, barColor1End, percentage / 0.33);
        barColor2 = interpolateColor(barColor2Start, barColor2End, percentage / 0.33);

        const borderColorStart = '#f9c900';
        const borderColorEnd = '#9acd32';
        borderColor = interpolateColor(borderColorStart, borderColorEnd, percentage / 0.33);

        const sliderThumbColorStart = '#0053c9';
        const sliderThumbColorEnd = '#2e8b57';
        sliderThumbColor = interpolateColor(sliderThumbColorStart, sliderThumbColorEnd, percentage / 0.33);
      } else if (percentage <= 0.66) {
        const softColor1 = '#1e90ff';
        const softColor2 = '#20b2aa';
        const lightColor1 = '#a3d5ff';
        const lightColor2 = '#a3fff0';
        gradient1 = interpolateColor(softColor1, lightColor1, (percentage - 0.33) / 0.33);
        gradient2 = interpolateColor(softColor2, lightColor2, (percentage - 0.33) / 0.33);

        const textColorStart = '#2e8b57';
        const textColorEnd = '#5f9ea0';
        textColor = interpolateColor(textColorStart, textColorEnd, (percentage - 0.33) / 0.33);

        const barColor1Start = '#4682b4';
        const barColor1End = '#add8e6';
        const barColor2Start = '#87ceeb';
        const barColor2End = '#e6f3ff';
        barColor1 = interpolateColor(barColor1Start, barColor1End, (percentage - 0.33) / 0.33);
        barColor2 = interpolateColor(barColor2Start, barColor2End, (percentage - 0.33) / 0.33);

        const borderColorStart = '#9acd32';
        const borderColorEnd = '#d4ff4d';
        borderColor = interpolateColor(borderColorStart, borderColorEnd, (percentage - 0.33) / 0.33);

        const sliderThumbColorStart = '#2e8b57';
        const sliderThumbColorEnd = '#5f9ea0';
        sliderThumbColor = interpolateColor(sliderThumbColorStart, sliderThumbColorEnd, (percentage - 0.33) / 0.33);
      } else {
        const lightColor1 = '#a3d5ff';
        const lightColor2 = '#a3fff0';
        const whiteColor1 = '#ffffff';
        const whiteColor2 = '#f0f8ff';
        gradient1 = interpolateColor(lightColor1, whiteColor1, (percentage - 0.66) / 0.34);
        gradient2 = interpolateColor(lightColor2, whiteColor2, (percentage - 0.66) / 0.34);

        const textColorStart = '#5f9ea0';
        const textColorEnd = '#333333';
        textColor = interpolateColor(textColorStart, textColorEnd, (percentage - 0.66) / 0.34);

        const barColor1Start = '#add8e6';
        const barColor1End = '#f5faff';
        const barColor2Start = '#e6f3ff';
        const barColor2End = '#ffffff';
        barColor1 = interpolateColor(barColor1Start, barColor1End, (percentage - 0.66) / 0.34);
        barColor2 = interpolateColor(barColor2Start, barColor2End, (percentage - 0.66) / 0.34);

        const borderColorStart = '#d4ff4d';
        const borderColorEnd = '#ffffff';
        borderColor = interpolateColor(borderColorStart, borderColorEnd, (percentage - 0.66) / 0.34);

        const sliderThumbColorStart = '#5f9ea0';
        const sliderThumbColorEnd = '#333333';
        sliderThumbColor = interpolateColor(sliderThumbColorStart, sliderThumbColorEnd, (percentage - 0.66) / 0.34);
      }

      document.body.style.background = `linear-gradient(45deg, ${gradient1}, ${gradient2})`;
      document.querySelectorAll('.bar-value, .bar-label, .title, .footer').forEach(el => {
        el.style.color = textColor;
      });
      document.querySelectorAll('.bar-rect').forEach(el => {
        el.style.background = `linear-gradient(to top, ${barColor1}, ${barColor2})`;
      });
      document.querySelectorAll('.bar-rect, .portrait-box').forEach(el => {
        el.style.borderTopColor = borderColor;
      });
      document.querySelectorAll('[contenteditable="true"]:focus').forEach(el => {
        el.style.outlineColor = borderColor;
      });
      document.querySelectorAll('.portrait-box:hover').forEach(el => {
        el.style.outlineColor = borderColor;
      });

      const sliderStyle = document.querySelector('.color-slider');
      sliderStyle.style.setProperty('--thumb-color', sliderThumbColor);
    }

    function interpolateColor(color1, color2, factor) {
      const r1 = parseInt(color1.substr(1, 2), 16);
      const g1 = parseInt(color1.substr(3, 2), 16);
      const b1 = parseInt(color1.substr(5, 2), 16);
      const r2 = parseInt(color2.substr(1, 2), 16);
      const g2 = parseInt(color2.substr(3, 2), 16);
      const b2 = parseInt(color2.substr(5, 2), 16);
      const r = Math.round(r1 + (r2 - r1) * factor).toString(16).padStart(2, '0');
      const g = Math.round(g1 + (g2 - g1) * factor).toString(16).padStart(2, '0');
      const b = Math.round(b1 + (b2 - b1) * factor).toString(16).padStart(2, '0');
      return `#${r}${g}${b}`;
    }

    function setBackgroundImage(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const backgroundLayer = document.getElementById('background-image-layer');
          backgroundLayer.style.backgroundImage = `url(${e.target.result})`;
          backgroundLayer.style.display = 'block';
          document.getElementById('removeBackgroundButton').style.display = 'flex';
        };
        reader.readAsDataURL(file);
      }
    }

    function removeBackgroundImage() {
      const backgroundLayer = document.getElementById('background-image-layer');
      backgroundLayer.style.backgroundImage = '';
      backgroundLayer.style.display = 'none';
      document.getElementById('removeBackgroundButton').style.display = 'none';
    }

    document.body.addEventListener('dragover', (e) => {
      e.preventDefault();
    });

    document.body.addEventListener('drop', (e) => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const backgroundLayer = document.getElementById('background-image-layer');
          backgroundLayer.style.backgroundImage = `url(${e.target.result})`;
          backgroundLayer.style.display = 'block';
          document.getElementById('removeBackgroundButton').style.display = 'flex';
        };
        reader.readAsDataURL(file);
      }
    });
  </script>
</body>
</html>